import sqlite3
from sqlite3 import Error

def conexionDB():
    try:
        con=sqlite3.connect('BDEjemplo.db')   # Creacion de conexciòn
        return con
    except Error:
        print("Erro en la conexcion de la base de datos ")

def CerrarBD(con):
    con.close()
    

def CrearTablaVehiculos(con):
    cursorObj=con.cursor()   # Objeto que recorre todo el repositorio de bases de datos.
    cursorObj.execute('''CREATE TABLE IF NOT EXISTS vehiculos(
                                placa text NOT NULL,
                                marca text NOT NULL, 
                                referencia text NOT NULL,
                                modelo integer NOT NULL,
                                numeroChasis text NOT NULL,
                                numeroMotor text NOT NULL,
                                color text NOT NULL,
                                concesionario text NOT NULL,
                                fechaCompraVehiculo date NOT Null,
                                tiempoGarantía integer NOT NULL,
                                fechaCompraPoliza date NOT NULL,
                                proveedorPoliza text NOT NULL,
                                fechaCompraSegObliga date NOT NULL,
                                proveedorSegObliga text NOT NULL,
                                activo integer NOT NULL,
                                PRIMARY KEY(placa))''')    #Cadena con SQL a ejecutar, creacion y ejecucion.
    con.commit()    # Asegurar la persistencia

    #Repetir proceso de creaciòn de tabla con conductores y mantenimiento de los vehiculos.
    
def CrearTablaConductor(con):
    cursorObj=con.cursor()   
    cad='''CREATE TABLE IF NOT EXISTS Conductores(
                                numeroIdentificacion integer NOT NULL,
                                nombre text NOT NULL, 
                                apellido text NOT NULL,
                                direccion text NOT NULL,
                                telefono integer NOT NULL,
                                coorreoElectronico text NOT NULL,
                                placaVehiculo text NOT NULL,
                                fechaIngreso date NOT NULL,
                                indicadorContratado integer NOT NULL,
                                turno integer NOT  NULL,
                                valorTurnpo integer NOT  NULL,
                                valorAhorro integer NOT  NULL,
                                valorAdeuda integer NOT NULL,
                                totalAhorradoNoDevuelto integer NOT NULL,
                                PRIMARY KEY(NumeroIdentificacion))'''
    cursorObj.execute(cad)
    con.commit()

    
def CrearTablaMantenimientoVehiculo(con):
    cursorObj=con.cursor()  
    cad='''CREATE TABLE IF NOT EXISTS mantenimientoVehiculo(
                                numeroDeOrden integer NOT NULL,
                                placaVehiculo text NOT NULL, 
                                nit text NOT NULL,
                                nombreProveedor text NOT NULL,
                                descripcionServicio text NOT NULL,
                                valorFacturado text NOT NULL,
                                fechaServicio date NOT NULL,
                                PRIMARY KEY(numeroDeOrden))'''
    cursorObj.execute(cad)
    con.commit()    


def insertarVehiculos(con):
    cursorObj=con.cursor()
    cursorObj.execute
    cad='''INSERT INTO vehiculos VALUES ("LSV252",
                                        "RENAULT",
                                        "SYMBOL",
                                        2014,
                                        "123asd",
                                        "456lki",
                                        "BLANCO",
                                        "Los Coches",
                                        "12/09/2013",
                                        36,
                                        "12/09/2013",
                                        "Seguros del Estado",
                                        "12/09/2013",
                                        "Seguros del Estado",
                                        1)'''
    cursorObj.execute(cad)
    con.commit()

def LeerInformacionMantenimiento():
        numeroDeOrden=input("Numero de Orden: ")
        placaVehiculo=input("Placa: ")
        nit=input("Nit: ")
        nombreProveedor=input("Proveedor: ")
        descripcionServicio=input("Servicio Prestado: ")
        valorFacturado=input("Valor Facturado: ")
        from datetime import datetime    #Importar datatime para poder utilizar fechas
        fecha=True
        while fecha==True:
                    fechaServicio =input("Fecha de Servecio en formato dd/mm/aaaa: ")
                    try:
                        fecha= datetime.strptime(fechaServicio, "%d/%m/%Y").date()    #Convertir la cadena string en un objeto datetime
                        fecha_base = fecha.strftime("%Y-%m-%d")    #Convertir objeto datetime en una cadena legible
                        break
                    except ValueError:
                        print("Fecha invalida,  ingrese de nuevo la fecha ")
        mantenimiento=(numeroDeOrden, placaVehiculo, nit, nombreProveedor, descripcionServicio, valorFacturado, fecha_base)    #Variale utilizada para formar una tupla con los datos ingresados
        return mantenimiento    #Devolver la variable para poder ser utilizada en otros metodos

def ConsultarMantenimientoRealizado(con):
        cursorObj=con.cursor()
        numeroDeOrden=input("Numero de Orden: ")
        cad='SELECT numeroDeOrden,  placaVehiculo, nit, nombreProveedor, descripcionServicio,  valorFacturado,fechaServicio FROM mantenimientoVehiculo WHERE numeroDeOrden='+numeroDeOrden
        cursorObj.execute(cad)
        filas=cursorObj.fetchall()    #Recupera todos los datos de cad
        if not filas:    #Si filas esta vacio entonces saltara un mensaje de error
            print("Numero de orden inexistente")
            return
        else:
            for row in filas:    #Filas en las que se atrapan los datos obtenidos de forma ordenada y coherente con el numero de columnas de la tabla
                numeroDeOrden=row[0]
                placa=row[1]
                ni=row[2]
                proveedor=row[3]
                descripcion = row[4]
                valor = row[5]
                fecha = row[6]
                
                print("Numero de Orden: ",numeroDeOrden,
                      "\nPlaca: ",placa,
                      "\nProveedor: ",proveedor,
                      "\nNit: ",ni,
                      "\nDescripcion del servicio prestado: ",descripcion,
                      "\nValor facturado: ",valor,
                      "\nFecha del servicio: ",fecha)
    
def CrearMantenimiento(con,mant):
    try:
        cursorObj=con.cursor()
        cursorObj.execute('''INSERT INTO mantenimientoVehiculo (numeroDeOrden, placaVehiculo, nit, nombreProveedor, descripcionServicio, valorFacturado, fechaServicio) Values(?,?,?,?,?,?,?)''',mant)
        con.commit()
        print("Se creo correctamente el mantenimiento ")
    except sqlite3.IntegrityError as error:    #Excepciòn de error de integridad para evitar que hallan campos vacios o numeros de orden repetidos
        if "UNIQUE constraint failed" in str(error):
            print("Numero de orden repetido")
        else:
            print("No se aceptan campos vacios, por favor ingresar de nuevo los datos ", )


def ActualizarMantenimientoRealizado(con):
    try:
        cursorObj=con.cursor()
        numeroDeOrden=input("Numero de Orden: ")
        cursorObj.execute("SELECT 1 FROM mantenimientoVehiculo WHERE numeroDeOrden="+numeroDeOrden)
        if cursorObj.fetchone() is None:    #Obtener una sola fila del resultado de la consulta para que si no encuentra nada imprima un mensaje de error
                print("No se encontro Mantenimiento, Numero de orden inexistente")
                return    #Si encuentra alo devuelve el valor, si no encuentra nada devuelve None
        placaVehiculo=input("Placa: ")
        nit=input("Nit: ")
        nombreProveedor=input("Nombre del Proveedor")
        descripcionServicio=input("Descripciòn del Servicio Prestado: ")
        valorFacturado=input("Valor Facturado: ")
        from datetime import datetime
        fecha=True    #Valor booleano para poder crear un bucle while hasta que la fecha sea ingresada correctamente
        while fecha==True:
                    fechaServicio =input("Fecha de Servecio en formato dd/mm/aaaa: ")
                    try:
                        fecha= datetime.strptime(fechaServicio, "%d/%m/%Y").date()
                        fecha_base = fecha.strftime("%Y-%m-%d")
                        break    #Salir del bulce si el usuario ingresa de forma correcta la fecha
                    except ValueError:    #Captura el error si la fecha esta en un formato invalido
                        print("Fecha invalida,  ingrese de nuevo la fecha ")
        #Si alguno de los campos esta vacio imprimira un mensaje de error, el operador not invierte el valor logico y strip elimina los espacios al inicio y al final de la cadena
        if (not placaVehiculo.strip() or not nit.strip() or not nombreProveedor.strip() or
            not descripcionServicio.strip() or not valorFacturado.strip() or not fechaServicio.strip()):
            print("No se aceptan campos vacíos. Por favor ingrese de nuevo los datos.")
            return
        cad = ( "UPDATE mantenimientoVehiculo SET "
                        "placaVehiculo='" + placaVehiculo + "', "
                        "nit='" + nit + "', "
                        "nombreProveedor='" + nombreProveedor + "', "
                        "descripcionServicio='" + descripcionServicio + "', "
                        "valorFacturado='" + valorFacturado + "', "
                        "fechaServicio='" + fechaServicio + "' "
                        "WHERE numeroDeOrden='" + numeroDeOrden + "'")
        cursorObj.execute(cad)
        con.commit()
        print("Se actualizo correctamente el Mantenimiento con el Numero de Orden:  ",numeroDeOrden)
    except sqlite3.IntegrityError as error:    #Atrapa el error de integridad como "error"
            print("campos vacios o invalidos ")
            

def BorrarMantenimiento(con):
        cursorObj=con.cursor()
        numeroDeOrden=input("Numero de Orden: ")
        cad='DELETE FROM mantenimientoVehiculo WHERE  numeroDeOrden='+numeroDeOrden  
        cursorObj.execute(cad)
        if cursorObj.rowcount == 0:    #Saber cuantas columnas de la tabla fueron afectadsa en la ejecuciòn, si fueron 0 entonce marcara un mensaje de error
            print("Numero de orden inexistente, no se pudo eliminar nada")
        else:
            print("Se elimino el mantenimiento con el numero de orden: ",numeroDeOrden)
        con.commit()

def menu(con):
    salirPrincipal=False
    while not salirPrincipal:
        opcPrincipal=input('''MENU PRINCIPAL TAXIS LA NACIONAL
                                            1- Menù de gestiòn de Vehiculos
                                            2- Menù de gestiòn de Conductores
                                            3- Menù de gestiòn de Mantenimientos
                                            4- Ficha de Vehiculo
                                            5- Salir

                                            Seleccione una opciòn: >>>''')
        if  (opcPrincipal=='1'):
                    salirPrincipal==True
        elif    (opcPrincipal=='2'):
                    salirConductores=False
                    while not salirConductores:
                        opcConductores=input('''Menu de administracion de conductores
                                                                    1-Crea un nuevo conductor
                                                                    2- Actualizar informacion de un conductor
                                                                    3- Consultar la informacion de un conductor
                                                                    4- Retornar al menù principal

                                                                    Selecciones una opciòn: >>> ''')
                        if  (opcConductores=='1'):
                                salirConducroes=True
                        elif    (opcConductores=='2'):
                                salirConducroes=True
                        elif    (opcConductores=='3'):
                                salirConductores=True
                        elif    (opcConductores=='4'):
                                salirConductores=True
        elif    (opcPrincipal=='3'):
                    salirMantenimiento=False
                    while not salirMantenimiento:
                                    opcMantenimientos=input('''Menu De Mantenimientos
                                                                                    1- Crear una Mantenimiento
                                                                                    2- Consultar Mantenimiento Realizado
                                                                                    3- Borrar Manteniento
                                                                                    4- Actualizar mantenimiento
                                                                                    5- Retornar al menù principal

                                                                                    Seleccione una opciòn: >>>''')
                                    
                                    if  (opcMantenimientos=='1'):
                                            MiMantenimiento=LeerInformacionMantenimiento()
                                            CrearMantenimiento(con,MiMantenimiento)
                                    elif    (opcMantenimientos=='2'):
                                            ConsultarMantenimientoRealizado(con)
                                    elif    (opcMantenimientos=='3'):
                                            BorrarMantenimiento(con)
                                    elif (opcMantenimientos=='4'):
                                            ActualizarMantenimientoRealizado(con)
                                    elif    (opcMantenimientos=='5'):
                                            salirMantenimiento=True
                                    else:
                                        print("Opcion no existente, intente de nuevo ")
                                        salirMantenimiento=False
        elif    (opcPrincipal=='4'):
            datos =datosVehiculo(con)
            if datos:
                nombrePDF = f"ficha_{datos['placa']}.pdf"
                generarFichaPDF(nombrePDF, datos)
            else:
                print("No se generó la ficha porque no se encontró el vehículo.")
        elif    (opcPrincipal=='5'):
                    salirPrincipal==True
                  
def datosVehiculo(con):
        placaVehiculo=input("Ingrese el numero de Placa del Vehiculo del cual desea imprimir la ficha tecnica: ")
        con.row_factory = sqlite3.Row   #Hace que las filas obtenidas se comporten como un diccionario
        cursorObj=con.cursor()
        cursorObj.execute("SELECT * FROM vehiculos WHERE placa ='"+placaVehiculo+"'")
        fila = cursorObj.fetchone()
        if fila is None:
            print("Vehiculo no encontrado")
            return None
        return dict(fila)   #Convierte las filas (objeto row) en diccionario directamente

from reportlab.lib.pagesizes import letter    #Importar el tamaño de la pagina en este caso carta
from reportlab.pdfgen import canvas    #Importar el modulo canvas para generar PDF
from datetime import datetime    #Importar la clase datatime para poder mostrar la fecha del reporte

def generarFichaPDF(fichaIntegrada, datos):
    ficha = canvas.Canvas(fichaIntegrada, pagesize=letter)  #Definir el nombre del archivo y el tamaño de la hoja, dentro de la variable ficha para usarse despues como variavle canvas 
    width, height = letter

    # Definir la fuente del encabezado con setFont y las lineas de los laterales de la hoja
    ficha.setFont("Helvetica-Bold", 18)
    ficha.drawString(180, height - 60, "FICHA INTEGRADA DEL VEHÍCULO")

    ficha.setFont("Helvetica", 12)     #Define la fuente de la fecha
    ficha.drawString(100, height - 90, f"Fecha de emisión: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")    #Obtiene la fecha exacta del sistema

    y = height - 130   #Altura mas baja para empezar a escribir el cuerpo de las lineas

    # Recolecciòn y muestra de los datos del vehiculo
    for campo, valor in datos.items():    #Recorrer el diccionario
        ficha.drawString(100, y, f"{campo.capitalize()}: {valor}")
        y -= 20

    # Mismo procedimiento para el pie de pagina y agregar el texto  de ficha generada
    ficha.setFont("Helvetica-Oblique", 10)
    ficha.drawString(100, 60, "Ficha Integral del Vehiculo generada.")
              
    ficha.save()    #Guaradar y cerrar el archivo PDF

    print("\nPDF generado correctamente: ")


    
    
def main():
    miCon=conexionDB()
    menu(miCon)
    #CrearTablaVehiculos(miCon)
    #CrearTablaConductor(miCon)
    #insertarVehiculos(miCon)
    #CrearTablaMantenimientoVehiculo(miCon)
    #MiMantenimiento=LeerInformacionMantenimiento()
    #CrearMantenimiento(miCon,MiMantenimiento)
    #CrearMantenimiento1(miCon)
    #ActualizarMantenimientoRealizado(miCon)
    #ConsultarMantenimientoRealizado(miCon)
    #ConsultarMantenimientoRealizado1(miCon)
    #ConsultarMantenimientoRealizado2(miCon)
    #ConsultarMantenimientoRealizado3(miCon)
    #BorrarMantenimiento(miCon)
    #BorrarTablaVehiculos(miCon)
    CerrarBD(miCon)
main()
